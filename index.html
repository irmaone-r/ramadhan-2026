<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khatam Hub - Rika & Azka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-soft { animation: pulse-soft 3s infinite; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 pb-24">

    <!-- Navigasi Atas / Header -->
    <header class="bg-emerald-800 text-white p-6 rounded-b-[2.5rem] shadow-2xl sticky top-0 z-50">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-black flex items-center gap-2 tracking-tighter">
                        <i data-lucide="moon" class="w-7 h-7 text-yellow-300 fill-current"></i> KHATAM HUB
                    </h1>
                    <p class="text-[10px] opacity-70 font-bold uppercase tracking-[0.2em] mt-1 flex items-center gap-1">
                        <i data-lucide="zap" class="w-3 h-3 text-emerald-400"></i> LIVE SYNC ACTIVE
                    </p>
                </div>
                <div id="countdown" class="flex gap-2 font-bold"></div>
            </div>
            
            <div class="bg-emerald-900/50 rounded-2xl p-3 border border-emerald-700/50 flex items-center gap-3">
                <div class="bg-emerald-500/20 p-2 rounded-xl">
                    <i data-lucide="sparkles" class="w-4 h-4 text-emerald-300"></i>
                </div>
                <p id="daily-quote" class="text-[11px] italic font-medium opacity-90 leading-tight">
                    "Memuat kutipan hari ini..."
                </p>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <!-- Status Koneksi -->
        <div id="sync-status" class="hidden flex items-center justify-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 py-1 rounded-full border border-emerald-100 uppercase tracking-widest">
            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span> Real-time Connected
        </div>

        <!-- Kartu Perbandingan Stats -->
        <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 relative overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-emerald-500"></i> Battle Progress
                </h3>
                <span id="day-badge" class="bg-emerald-50 text-emerald-700 text-[10px] font-black px-3 py-1 rounded-full border border-emerald-100 uppercase">
                    Ramadhan Day 1
                </span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-3 bg-emerald-50/30 p-4 rounded-3xl border border-emerald-100">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-emerald-800 opacity-60">RIKA</span>
                        <i data-lucide="heart" class="w-3 h-3 text-emerald-500 fill-current"></i>
                    </div>
                    <div class="text-center py-2">
                        <span id="rika-count" class="text-4xl font-black text-emerald-600">0</span>
                        <span class="text-xs text-emerald-300 font-bold">/30</span>
                    </div>
                    <div class="h-1.5 bg-emerald-100 rounded-full overflow-hidden">
                        <div id="rika-bar" class="h-full bg-emerald-500 transition-all duration-1000 w-0"></div>
                    </div>
                </div>

                <div class="space-y-3 bg-blue-50/30 p-4 rounded-3xl border border-blue-100">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-blue-800 opacity-60">AZKA</span>
                        <i data-lucide="zap" class="w-3 h-3 text-blue-500 fill-current"></i>
                    </div>
                    <div class="text-center py-2">
                        <span id="azka-count" class="text-4xl font-black text-blue-600">0</span>
                        <span class="text-xs text-blue-300 font-bold">/30</span>
                    </div>
                    <div class="h-1.5 bg-blue-100 rounded-full overflow-hidden">
                        <div id="azka-bar" class="h-full bg-blue-500 transition-all duration-1000 w-0"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pesan Status -->
        <div id="status-alert" class="bg-slate-900 text-white p-5 rounded-[2rem] flex items-center gap-4 border-b-4 border-emerald-500 shadow-xl">
            <div class="bg-emerald-500/20 p-3 rounded-2xl">
                <i data-lucide="message-circle" class="w-6 h-6 text-emerald-400"></i>
            </div>
            <div>
                <h4 id="status-title" class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-0.5">Sinkronisasi...</h4>
                <p id="status-desc" class="text-xs font-semibold opacity-90 leading-relaxed">
                    Menghubungkan ke Cloud Database Rika & Azka...
                </p>
            </div>
        </div>

        <!-- Daftar Juz -->
        <div class="space-y-4">
            <div id="juz-container" class="grid gap-3">
                <!-- Juz items injected here -->
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'khatam-rika-azka';

        let localState = { rika: {}, azka: {} };
        const SURAH_MAP = [
            "Al-Fatihah - Al-Baqarah 141", "Al-Baqarah 142 - 252", "Al-Baqarah 253 - Ali 'Imran 92",
            "Ali 'Imran 93 - An-Nisa 23", "An-Nisa 24 - 147", "An-Nisa 148 - Al-Ma'idah 81",
            "Al-Ma'idah 82 - Al-An'am 110", "Al-An'am 111 - Al-A'raf 87", "Al-A'raf 88 - Al-Anfal 40",
            "Al-Anfal 41 - At-Taubah 92", "At-Taubah 93 - Hud 5", "Hud 6 - Yusuf 52",
            "Yusuf 53 - Ibrahim 52", "Al-Hijr 1 - An-Nahl 128", "Al-Isra 1 - Al-Kahfi 74",
            "Al-Kahfi 75 - Ta Ha 135", "Al-Anbiya 1 - Al-Hajj 78", "Al-Mu'minun 1 - Al-Furqan 20",
            "Al-Furqan 21 - An-Naml 55", "An-Naml 56 - Al-'Ankabut 45", "Al-'Ankabut 46 - Al-Ahzab 30",
            "Al-Ahzab 31 - Yasin 27", "Yasin 28 - Az-Zumar 31", "Az-Zumar 32 - Fussilat 46",
            "Fussilat 47 - Al-Jathiyah 37", "Al-Ahqaf 1 - Adh-Dhariyat 30", "Adh-Dhariyat 31 - Al-Hadid 29",
            "Al-Mujadila 1 - At-Tahrim 12", "Al-Mulk 1 - Al-Mursalat 50", "An-Naba 1 - An-Nas 6"
        ];

        async function init() {
            try {
                // RULE 3: Auth Dulu Baru Query
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // FIX: Memastikan 6 segmen path sesuai RULE 1
                        // artifacts (1) / {appId} (2) / public (3) / data (4) / khatam (5) / progress (6)
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'khatam', 'progress');
                        
                        onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                localState = docSnap.data();
                                render();
                            } else {
                                setDoc(docRef, { rika: {}, azka: {} });
                            }
                            document.getElementById('sync-status').classList.remove('hidden');
                        }, (error) => {
                            console.error("Firestore Error:", error);
                        });
                    }
                });
            } catch (err) {
                console.error("Auth Error:", err);
            }
        }

        window.toggleJuz = async function(juzId, person) {
            if (!auth.currentUser) return;
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'khatam', 'progress');
            const newState = { ...localState };
            newState[person] = newState[person] || {};
            newState[person][juzId] = !newState[person][juzId];
            
            try {
                await updateDoc(docRef, {
                    [person]: newState[person]
                });
            } catch (e) {
                await setDoc(docRef, newState);
            }
        };

        function updateCountdown() {
            const EID_TARGET = new Date('2026-03-20T00:00:00');
            const RAMADHAN_START = new Date('2026-03-19T00:00:00');
            const now = new Date();
            const distance = EID_TARGET.getTime() - now.getTime();
            
            if (distance > 0) {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById('countdown').innerHTML = `
                    <div class="bg-white/10 px-3 py-1.5 rounded-2xl text-center border border-white/20"><span class="text-base block leading-none">${days}</span><span class="text-[7px] opacity-60 uppercase">Hari</span></div>
                    <div class="bg-white/10 px-3 py-1.5 rounded-2xl text-center border border-white/20"><span class="text-base block leading-none">${hours}</span><span class="text-[7px] opacity-60 uppercase">Jam</span></div>
                `;
            }

            const diffTime = now.getTime() - RAMADHAN_START.getTime();
            let currentDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            currentDay = Math.max(1, Math.min(30, currentDay));
            document.getElementById('day-badge').innerText = `Ramadhan Day ${currentDay}`;
            
            const quotes = [
                "Bacalah Al-Qur'an, ia akan memberi syafaat di kiamat.",
                "Satu huruf Al-Qur'an adalah sepuluh kebaikan.",
                "Sebaik-baik kalian adalah yang belajar Al-Qur'an.",
                "Ramadhan adalah bulan penuh keberkahan Al-Qur'an."
            ];
            document.getElementById('daily-quote').innerText = quotes[currentDay % quotes.length];
            
            return currentDay;
        }

        function render() {
            const container = document.getElementById('juz-container');
            const currentDay = updateCountdown();
            container.innerHTML = '';

            let rikaTotal = 0;
            let azkaTotal = 0;

            for (let i = 1; i <= 30; i++) {
                const doneRika = localState.rika && localState.rika[i];
                const doneAzka = localState.azka && localState.azka[i];
                if (doneRika) rikaTotal++;
                if (doneAzka) azkaTotal++;

                const isTarget = i === currentDay;
                const item = document.createElement('div');
                item.className = `bg-white p-5 rounded-[2rem] border-2 transition-all duration-300 flex items-center justify-between shadow-sm ${doneRika && doneAzka ? 'border-emerald-500 bg-emerald-50/20' : isTarget ? 'border-yellow-400 bg-yellow-50/30' : 'border-slate-50'}`;
                
                item.innerHTML = `
                    <div class="flex items-center gap-5">
                        <div class="relative">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center font-black text-lg ${doneRika && doneAzka ? 'bg-emerald-600 text-white' : isTarget ? 'bg-yellow-400 text-yellow-900' : 'bg-slate-100 text-slate-400'}">
                                ${i}
                            </div>
                        </div>
                        <div>
                            <div class="text-xs font-black text-slate-800 uppercase tracking-tight">JUZ ${i}</div>
                            <div class="text-[10px] text-slate-400 font-bold truncate max-w-[130px]">${SURAH_MAP[i-1]}</div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="toggleJuz(${i}, 'rika')" class="flex flex-col items-center gap-1 group">
                            <div class="p-2.5 rounded-2xl ${doneRika ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-50 text-slate-200'}">
                                <i data-lucide="${doneRika ? 'check-circle' : 'circle'}" class="w-5 h-5"></i>
                            </div>
                            <span class="text-[8px] font-black text-slate-400 uppercase">Rika</span>
                        </button>
                        <button onclick="toggleJuz(${i}, 'azka')" class="flex flex-col items-center gap-1 group">
                            <div class="p-2.5 rounded-2xl ${doneAzka ? 'bg-blue-100 text-blue-600' : 'bg-slate-50 text-slate-200'}">
                                <i data-lucide="${doneAzka ? 'check-circle' : 'circle'}" class="w-5 h-5"></i>
                            </div>
                            <span class="text-[8px] font-black text-slate-400 uppercase">Azka</span>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            }

            document.getElementById('rika-count').innerText = rikaTotal;
            document.getElementById('azka-count').innerText = azkaTotal;
            document.getElementById('rika-bar').style.width = `${(rikaTotal/30)*100}%`;
            document.getElementById('azka-bar').style.width = `${(azkaTotal/30)*100}%`;
            
            updateStatusText(rikaTotal, azkaTotal);
            lucide.createIcons();
        }

        function updateStatusText(rika, azka) {
            const title = document.getElementById('status-title');
            const desc = document.getElementById('status-desc');
            if (rika > azka) {
                title.innerText = "RIKA MEMIMPIN!";
                desc.innerText = "Azka, jangan mau kalah! Ayo tadarus lagi!";
            } else if (azka > rika) {
                title.innerText = "AZKA LAGI NGEBUT!";
                desc.innerText = "Rika semangat! Dikit lagi bisa disalip kok.";
            } else if (rika === 0 && azka === 0) {
                title.innerText = "SIAP MULAI?";
                desc.innerText = "Ayo isi progres khatam kalian di sini!";
            } else {
                title.innerText = "KOMPAK BANGET!";
                desc.innerText = "Kalian berdua luar biasa, progresnya sama persis!";
            }
        }

        init();
        setInterval(updateCountdown, 60000);
    </script>
</body>
</html>